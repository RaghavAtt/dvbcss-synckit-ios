<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SyncController  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    <!-- new top header bar across all sub-frameworks --> <div style="margin:0; width: 100%; padding: 8px 0 8px 8px; background-color: #005" class="header">
    <a href="../../../../../../index.html" style="margin: 0; padding: 0 8px; font-weight: bold; color:white;">
        dvbcss-synckit-ios
    </a>
</div> <!-- shuffle the "view on github" link up to be on the new top header bar --> <style type="text/css">
    header .header-col.header-col--secondary a.header-link {
        position: relative;
        top: -39px;
    }
</style>

  </head>
  <body>


    <a title="SyncController  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          SyncController Docs
        </a>
        
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/bbc/dvbcss-synckit-ios">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">SyncController Reference</a>
      <img class="carat" src="img/carat.png" />
      SyncController  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/AudioSyncController.html">AudioSyncController</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SyncControllerError.html">SyncControllerError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/VideoPlayerSyncController.html">VideoPlayerSyncController</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WebViewProxy.html">WebViewProxy</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WebViewSyncController.html">WebViewSyncController</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Constants.html">Constants</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@SyncControllerErrorDomain">SyncControllerErrorDomain</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@SyncControllerVersionNumber">SyncControllerVersionNumber</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@SyncControllerVersionString">SyncControllerVersionString</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kAudioSyncControllerResyncNotification">kAudioSyncControllerResyncNotification</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerMediaNotSeekable">kSyncControllerMediaNotSeekable</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerNoSyncTimeline">kSyncControllerNoSyncTimeline</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerPlayerRateError">kSyncControllerPlayerRateError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kSyncControllerSyncTimelineUnavailable">kSyncControllerSyncTimelineUnavailable</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kVideoSyncControllerResyncNotification">kVideoSyncControllerResyncNotification</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@kWebSyncControllerResyncNotification">kWebSyncControllerResyncNotification</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/AudioSyncControllerState.html">AudioSyncControllerState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/VideoSyncControllerState.html">VideoSyncControllerState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/WebSyncControllerState.html">WebSyncControllerState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/kSyncControllerErrorTypes.html">kSyncControllerErrorTypes</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/InvocationProcessor.html">InvocationProcessor</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/SyncControllerDelegate.html">SyncControllerDelegate</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <a href='#small-dvbcss-synckit-ios-small-br-synccontroller-framework' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='small-dvbcss-synckit-ios-small-br-synccontroller-framework'><small>dvbcss-synckit-ios</small><br/>SyncController Framework</h1>

<ul>
<li><strong><a href="#overview">Overview</a></strong></li>
<li><strong><a href="#how-to-use">How to use</a></strong></li>
<li><strong><a href="#run-the-example-apps">Run the example apps</a></strong></li>
</ul>

<p>This library provides <em>SyncController</em> classes that can be used to synchronise a native media player to a given timeline.
Currently, a SyncController class is provided for each media player/web kit.</p>

<p>It is planned to coalesce these into a single implementation in the future.</p>

<p>SyncController objects must be initialised with at least the following objects:
* a media player (player objects, or player ViewController objects, from the <a href="../../../../../../AudioPlayerEngine">AudioPlayerEngine</a> or [<a href="../../../../../../VideoPlayer">../../../../../../VideoPlayer</a>) frameworks or in the case of a web view,  a UIWebView instance)
* a timeline to synchronise to (e.g. the Synchronisation Timeline - our local estimate of the TV&rsquo;s timeline)
* a correlation timestamp (a pair of timestamps) describing the relationship between the media timeline and the Synchronisation Timeline</p>
<a href='#dependencies' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='dependencies'>Dependencies</h4>

<p>This framework requires the following dynamic libraries (iOS frameworks) (found in SyncKit):</p>

<ul>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../SyncKitConfiguration">SyncKitConfiguration</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../SimpleLogger">SimpleLogger</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../VideoPlayer">VideoPlayer</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../AudioPlayer">AudioPlayerEngine</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../ClockTimelines">ClockTimelines</a></li>
</ul>
<a href='#overview' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='overview'>Overview</h2>

<p>TODO (Matt): write something here summarising what is in this library and how it works, once Rajiv has updated the more detailed stuff below.</p>
<a href='#how-to-use' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='how-to-use'>How to use</h2>
<a href='#1-add-the-framework-and-its-dependencies-to-your-project' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='1-add-the-framework-and-its-dependencies-to-your-project'>1. Add the framework and its dependencies to your project</h4>

<p>A Cocoa Pod version of this library is not currently available. To use this library, you must add it and its dependencies to your project.</p>

<p>You will need the following projects from this repository:</p>

<ul>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../../SyncKitConfiguration">SyncKitConfiguration</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../../SimpleLogger">SimpleLogger</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../../VideoPlayer">VideoPlayer</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../../AudioPLayer">AudioPlayerEngine</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../../ClockTimelines">ClockTimelines</a></li>
</ul>

<p>Either include them in your workspace and build them; or build them in this repository&rsquo;s <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/../synckit.xcworkspace">synckit.xcworkspace</a></p>

<p>Then add them under <em>Linked Frameworks and libraries</em> in your project&rsquo;s target configuration:</p>

<ul>
<li>SyncKitConfiguration.framework</li>
<li>SimpleLogger.framework</li>
<li>VideoPlayer.framework</li>
<li>AudioPlayerEngine.framework</li>
<li>ClockTimelines.framework</li>
</ul>

<p>If you have two XCode instances running you can drag and drop the framework files from their respective project in SyncKit to your own project.</p>
<a href='#2-import-the-header-files' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='2-import-the-header-files'>2. Import the header files</h4>

<p>Import this header file into your source file:</p>
<pre class="highlight plaintext"><code>
#import &lt;SyncController/SyncController.h&gt;

</code></pre>
<a href='#create-and-configure-a-video-synccontroller-object' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='create-and-configure-a-video-synccontroller-object'>Create and configure a video SyncController object</h4>

<p>When a Synchronisation Timeline is available, a VideoPlayerSyncController can be initialised with a video player, the Synchronisation Timeline and a correlation timestamp and then started. The change in the <code>available</code> property is observed using Key-Value-Observer pattern.</p>

<p>A SyncController object uses a timer to trigger a resync operation (reevaluating the media player&rsquo;s current time w.r.t. the expected media time).</p>

<p>The resync algorithm uses a simple strategy to catchup - if the asynchrony between the media player and the TV is more than <code>reSyncJitterThreshold</code> seconds, it requests the media player to seek to the new time position.
The default value is 0.02s for the <code>reSyncJitterThreshold</code> of a VideoPlayerSyncController object is <code>0,02s</code>.</p>
<pre class="highlight plaintext"><code>...
@property(nonatomic, readwrite) VideoPlayerSyncController * vSyncController;
...

- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSString *,id&gt; *)change context:(void *)context
{
    if (context == WallClockContext) {
        if ([keyPath isEqualToString:kAvailableKey])
        {
            NSNumber *newAvailability = [change objectForKey:@"new"];

            NSLog(@"ViewController: WallClock is synchronised.");

            // only start timeline sync when wallclock is in sync
            if (([newAvailability boolValue] == YES) &amp;&amp; (_tvTimelineSyncer==nil)){
                NSLog(@"ViewController: synchronising timeline");
                [self startTimelineSync];
            }

        }
     }
    else if (context == TVTimelineContext) {

      if ([keyPath isEqualToString:kAvailableKey]) {

            BOOL oldTVTimelineAvailable = [[change objectForKey:@"old"]boolValue];
            BOOL newTVTimelineAvailable = [[change objectForKey:@"new"]boolValue];

            if (newTVTimelineAvailable){

                // start the video player
                [self startVideo];

                // setup a sync controller for video player
                Correlation corel = [CorrelationFactory create:0 Correlation:0];

                self.vSyncController = [VideoPlayerSyncController
                                        syncControllerWithVideoPlayer:self.videoPlayer
                                                        SyncTimeline:self.tvTimeline
                                                CorrelationTimestamp:&amp;corel
                                                        SyncInterval:4.0
                                                        AndDelegate:self];
                [self.vSyncController start];
            }
        }
    }
}

</code></pre>
<a href='#observe-the-synccontroller-status' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='observe-the-synccontroller-status'>Observe the SyncController status</h4>

<p>Each SyncController object can have a delegate that conforms  <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/SyncController/SyncController/SyncControllerDelegate.h">SyncControllerDelegate</a> protocol. The delegate will then receive callbacks when the SyncController changes state. Possible SyncController states are:</p>
<pre class="highlight plaintext"><code>
typedef NS_ENUM(NSUInteger, VideoSyncControllerState)
{
    VideoSyncCrtlInitialised = 1,
    VideoSyncCrtlRunning,
    VideoSyncCrtlStopped,
    VideoSyncCrtlPaused,
    VideoSyncCrtlSynchronising,
    VideoSyncCrtlSyncTimelineUnavailable,
    VideoSyncCrtlSyncTimelineAvailable
};

</code></pre>

<p>Here is an example of a state change callback handler:</p>
<pre class="highlight plaintext"><code>
- (void) SyncController:(id) controller DidChangeState:(NSUInteger) state
{
    if (state == VideoSyncCrtlSyncTimelineAvailable) {

        if (![self.videoPlayer isPlaying])
        {
            [self.videoPlayer play];
        }
    }
}

</code></pre>
<a href='#run-the-example-apps' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='run-the-example-apps'>Run the example apps</h2>

<p>Three demo apps are included with this library:
* <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/VideoSyncDemoApp/">VideoSyncDemoApp</a> - synchronising an HLS stream or a file-based video asset to a DVB-CSS TV
* <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/AudioSyncDemoApp/">AudioSyncDemoApp</a> - synchronising an audio stream (mp3, aac, etc.) to a DVB-CSS TV
* <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/SyncController/WebViewSyncDemoApp">WebViewSyncDemoApp</a> - synchronising a web page animation to a DVB-CSS TV</p>

<p>To run these demo apps, you&rsquo;ll need the companion and TV assets. You can download them <a href="https://hbbtv-2-0-testing-1.virt.ch.bbc.co.uk/downloads/simple-free-sync-seq-1.zip">here</a>.</p>

<p>In each demo app project, you will need to specify the following constants:</p>
<pre class="highlight plaintext"><code>
NSString *serverAddress     = @"192.168.1.74";    // TV's IP address
NSString *contentId         = @"http://127.0.0.1:8123/channel_B_video.mp4";  // contentId of TV asset
NSString *timelineSelector  = @"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000";
NSString *tsEndpointURL     = @"ws://192.168.1.74:7681/ts";
int tick_rate = 5000;

</code></pre>

<p>To discover valid values for the <code>contentId</code>, <code>timelineSelector</code> and <code>tsEndpointURL</code>, you may use a CII client to connect to your TV.</p>
<pre class="highlight shell"><code><span class="gp">$ </span>python examples/CIIClient.py ws:/&lt;TV_IP_ADDRESS&gt;:7681/cii

</code></pre>

<p>What the received CII info may look like:</p>
<pre class="highlight shell"><code>
RD000400:pydvbcss rajivr<span class="nv">$ </span>python examples/CIIClient.py ws://10.5.11.163:7681/cii
INFO:CIIClient:connected
INFO:CIIClient:change to presentationStatus property. Value is now: <span class="o">[</span>u<span class="s1">'okay'</span><span class="o">]</span>
INFO:CIIClient:change to protocolVersion property. Value is now: 1.1
INFO:CIIClient:change to mrsUrl property. Value is now: None
INFO:CIIClient:change to timelines property. Value is now: <span class="o">[</span>TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>5000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)</span>, TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:1000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>1000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)]</span>
INFO:CIIClient:change to tsUrl property. Value is now: ws://10.5.11.163:7681/ts
INFO:CIIClient:change to wcUrl property. Value is now: udp://10.5.11.163:6677
INFO:CIIClient:change to contentIdStatus property. Value is now: final
INFO:CIIClient:change to contentId property. Value is now: http://127.0.0.1:8123/channel_B_video.mp4
INFO:CIIClient:CII is now: CII<span class="o">(</span><span class="nv">presentationStatus</span><span class="o">=[</span>u<span class="s1">'okay'</span><span class="o">]</span>, <span class="nv">protocolVersion</span><span class="o">=</span>u<span class="s1">'1.1'</span>, <span class="nv">mrsUrl</span><span class="o">=</span>None, <span class="nv">timelines</span><span class="o">=[</span>TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>5000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)</span>, TimelineOption<span class="o">(</span><span class="nv">timelineSelector</span><span class="o">=</span><span class="s2">"tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:1000"</span>, <span class="nv">unitsPertick</span><span class="o">=</span>1, <span class="nv">unitsPerSecond</span><span class="o">=</span>1000, <span class="nv">accuracy</span><span class="o">=</span>OMIT <span class="nv">private</span><span class="o">=</span>OMIT<span class="o">)]</span>, <span class="nv">tsUrl</span><span class="o">=</span>u<span class="s1">'ws://10.5.11.163:7681/ts'</span>, <span class="nv">wcUrl</span><span class="o">=</span>u<span class="s1">'udp://10.5.11.163:6677'</span>, <span class="nv">contentIdStatus</span><span class="o">=</span>u<span class="s1">'final'</span>, <span class="nv">contentId</span><span class="o">=</span>u<span class="s1">'http://127.0.0.1:8123/channel_B_video.mp4'</span><span class="o">)</span>

</code></pre>

<ul>
<li>The contentId in this example is <strong><q>http://127.0.0.1:8123/channel_B_video.mp4</q></strong></li>
<li>The timelineSelector is <strong><q>tag:rd.bbc.co.uk,2015-12-08:dvb:css:timeline:simple-elapsed-time:5000</q></strong>,</li>
<li>The timeline synchronisation server (tsURL) is <strong>ws://10.5.11.163:7681/ts</strong></li>
</ul>
<a href='#licence' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='licence'>Licence</h2>

<p>The SyncController iOS Framework is developed by BBC R&amp;D and distributed under Licensed under the Apache License, <a href="http://www.apache.org/licenses/LICENSE-2.0">Version 2.0</a>.</p>

<p>© Copyright 2016 BBC R&amp;D. All Rights Reserved</p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; British Broadcasting Corporation, under <a class="link" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="external">Apache 2.0 open source licence</a></p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.2</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
