<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WallClockClient  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    <!-- new top header bar across all sub-frameworks --> <div style="margin:0; width: 100%; padding: 8px 0 8px 8px; background-color: #005" class="header">
    <a href="../index.html" style="margin: 0; padding: 0 8px; font-weight: bold; color:white;">
        dvbcss-synckit-ios
    </a>
</div> <!-- shuffle the "view on github" link up to be on the new top header bar --> <style type="text/css">
    header .header-col.header-col--secondary a.header-link {
        position: relative;
        top: -39px;
    }
</style>

  </head>
  <body>


    <a title="WallClockClient  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          WallClockClient Docs
        </a>
        
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/bbc/dvbcss-synckit-ios">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">WallClockClient Reference</a>
      <img class="carat" src="img/carat.png" />
      WallClockClient  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Candidate.html">Candidate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/CandidateSink.html">CandidateSink</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/LowestDispersionAlgorithm.html">LowestDispersionAlgorithm</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/LowestDispersionFilter.html">LowestDispersionFilter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RTTThresholdFilter.html">RTTThresholdFilter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WCProtocolClient.html">WCProtocolClient</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WCSyncMessage.html">WCSyncMessage</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/WallClockSynchroniser.html">WallClockSynchroniser</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Constants.html">Constants</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@WallClockClientVersionNumber">WallClockClientVersionNumber</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Constants.html#/c:@WallClockClientVersionString">WallClockClientVersionString</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/ICandidateHandler.html">ICandidateHandler</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IFilter.html">IFilter</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IWCAlgo.html">IWCAlgo</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Type Definitions.html">Type Definitions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions/WCSyncMessagePkt.html">WCSyncMessagePkt</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Type Definitions/WCTimeValue.html">WCTimeValue</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <a href='#small-dvbcss-synckit-ios-small-br-wallclockclient-framework' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='small-dvbcss-synckit-ios-small-br-wallclockclient-framework'><small>dvbcss-synckit-ios</small><br/>WallClockClient Framework</h1>

<ul>
<li><strong><a href="#overview">Overview</a></strong></li>
<li><strong><a href="#how-to-use">How to use</a></strong></li>
<li><strong><a href="#run-the-example-app">Run the example app</a></strong></li>
</ul>

<p>This framework provides a client component that uses the DVB-CSS WallClock synchronisation (CSS-WC) protocol. It is used by Companion Screen applications to synchronise their Wall Clock with a TV that implements 
<a href="https://www.dvb.org/standards/dvb_css">DVB CSS</a> or 
<a href="http://hbbtv.org/resource-library/#specifications">HbbTV 2</a> specifications.</p>

<p>Use a <strong>WallClockSynchroniser</strong> to control a <strong>TunableClock</strong> object so that it represents an estimate of the TV&rsquo;s Wall Clock time. The tick rate of this clock must be 1,000,000,000.</p>
<a href='#dependencies' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='dependencies'>Dependencies</h4>

<p>This framework requires the following dynamic libraries (iOS frameworks) (found in SyncKit):</p>

<ul>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../SyncKitCollections">SyncKitCollections</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../SimpleLogger">SimpleLogger</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../UDPMessaging">UDPMessaging</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../ClockTimelines">ClockTimelines</a></li>
</ul>
<a href='#overview' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='overview'>Overview</h2>

<p>This framework library includes a number of components that, when connected together, will exchange messages with a CSS-WC protocol server, process the messages and generate measurements for the offset between the Companion Screen application&rsquo;s local WallClock and a TV and the initial dispersion value for that measurement. These candidate measurements (called Candidates) are then filtered and submitted to an algorithm for processing.</p>

<p>To perform WallClock time synchronisation, typically a companion application should:</p>

<ol>
<li><p><strong>Connect to the CSS-CII server</strong> in the same TV, using the <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../CIIProtocolClient">CIIProtocolClient</a> to find out:</p>

<ul>
<li>the current content ID</li>
<li>the endpoints for CSS-WC and CSS-TS</li>
<li>other state information about the TV</li>
</ul></li>
<li><p><strong>Create a <em>TunableClock</em> to represent the wall clock</strong>, with tick rate 1,000,000,000.</p></li>
<li><p><strong>Create a WallClockSynchroniser</strong>, telling it the URL of the endpoint for CSS-WC server in the TV, and providing the clock object.</p></li>
</ol>

<p>You can optionally choose to specify candidate measurement filters and processing algorithms:</p>

<ul>
<li><p>The Candidate measurement filter is used to drop candidates that are unlikely to provide a good estimate of the TV&rsquo;s WallClock time. For example, measurements  collected with large round-trip times (RTT) can be discarded by an RTTThreshold filter.</p></li>
<li><p>The candidate-processing algorithm determines if a new candidate measurement offers a better estimate of the TV&rsquo;s Wall Clock time than a previously-seen candidate measurement. For example, the <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockClient/WallClockClient/LowestDispersionAlgorithm.h">LowestDispersion</a> algorithm is used to ensure that only the candidate measurement with the current lowest dispersion value is selected as the currently-known best estimate of the TV WallClock time.</p></li>
</ul>

<p>Internally the WallClockSynchroniser instantiates other components in this framework:</p>

<ul>
<li><p><em>WCProtocolClient</em> - A CSS-WC protocol client to send CSS-WC requests and receive CSS-WC responses. On reception of WC response messages, the <em>WCProtocolClient</em> object creates a <em>Candidate</em> measurement object and submits it to a <em>CandidateSink</em> object for further proccesing.</p></li>
<li><p><em>CandidateSink</em> - A <em>Candidate</em> measurement handler object to send each new candidate through a chain of filters. If the candidate survives the filtration process, the <em>CandidateSink</em> object serves it to an algorithm for processing.</p></li>
<li><p><em>Algorithms (IWCAlgo protocol)</em> - e.g. <em>LowestDispersionAlgorithm</em> - An algorithm object to process Candidates and readjust the local WallClock&rsquo;s offset. WC algorithms must conform to the <em>IWCAlgo</em> protocol. Other algorithms can be developed and plugged in so long as they conform to the protocol.</p></li>
</ul>

<ol>
<li><em>Filters (IFilter protocol)</em> - e.g. <em>RTTThresholdFilter</em> - A filter that rejects unsuitable Candidates e.g. a candidates with an RTT that exceeds a specified threshold. Filters must conform to the <em>IFilter</em> protocol. Other filters can be developed and plugged in so long as they conform to the protocol.</li>
</ol>
<a href='#how-to-use' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='how-to-use'>How to use</h2>
<a href='#1-add-the-framework-and-its-dependencies-to-your-project' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='1-add-the-framework-and-its-dependencies-to-your-project'>1. Add the framework and its dependencies to your project</h4>

<p>A Cocoa Pod version of this library is not currently available. To use this library, you must add it and its dependencies to your project.</p>

<p>You will need the following projects from this repository:</p>

<ul>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../SyncKitCollections">SyncKitCollections</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../SimpleLogger">SimpleLogger</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../UDPMessaging">UDPMessaging</a></li>
<li><a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../ClockTimelines">ClockTimelines</a></li>
</ul>

<p>Either include them in your workspace and build them; or build them in this repository&rsquo;s <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/../synckit.xcworkspace">synckit.xcworkspace</a></p>

<p>Then add them under <em>Linked Frameworks and libraries</em> in your project&rsquo;s target configuration:</p>

<ul>
<li>SyncKitCollections.framework</li>
<li>SimpleLogger.framework</li>
<li>UDPMessaging.framework</li>
<li>ClockTimelines.framework</li>
</ul>

<p>If you have two XCode instances running you can drag and drop the framework files from their respective project in SyncKit to your own project.</p>
<a href='#import-the-header-files' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='import-the-header-files'>Import the header files</h4>

<p>Import this header file into your source file:</p>
<pre class="highlight plaintext"><code>#import &lt;WallClockClient/WallClockClient.h&gt;
#import &lt;ClockTimelines/ClockTimelines.h&gt;
</code></pre>
<a href='#create-and-configure-a-wallclock-synchroniser-object' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='create-and-configure-a-wallclock-synchroniser-object'>Create and configure a WallClock synchroniser object</h4>

<p>Create a clock object to represent the wall clock, with a system clock as its parent:</p>
<pre class="highlight plaintext"><code>SystemClock *sysCLK; 
TunableClock *wallclock;

sysCLK = [[SystemClock alloc] initWithTickRate:_kOneThousandMillion];

// create a tunable clock with tick rate of 1,000,000,000
// (matching the tick rate used for the Wall Clock protocol)

wallclock = [[TunableClock alloc] initWithParentClock:sysCLK TickRate:_kOneThousandMillion Ticks:0];
</code></pre>

<p>Using the defaults for candidate-processing algorithm (lowest dispersion) and filtering (RTT threshold), initialise a WallClockSynchroniser instance:</p>
<pre class="highlight plaintext"><code>WallClockSynchroniser   *wallclock_syncer; 

wallclock_syncer = [[WallClockSynchroniser alloc] initWithWCServer:serverAddress
                                                Port:6677 WallClock:wallclock];
</code></pre>
<a href='#register-for-notifications' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='register-for-notifications'>Register for notifications</h4>

<p>Register to be notified when the WallClock becomes <code>available</code> i.e. in a synchronised state</p>
<pre class="highlight plaintext"><code>[wallclock addObserver:self forKeyPath:kAvailableKey options:NSKeyValueObservingOptionOld | NSKeyValueObservingOptionNew context:WallClockContext];
</code></pre>
<a href='#start-the-wallclock-synchroniser' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='start-the-wallclock-synchroniser'>Start the WallClock synchroniser</h4>
<pre class="highlight plaintext"><code>[wallclock_syncer start];
</code></pre>
<a href='#run-the-example-app' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='run-the-example-app'>Run the example app</h2>

<p>A demo app called <a href="https://github.com/bbc/dvbcss-synckit-ios/tree/master/WallClockSync/WallClockCientDemoApp/">WallClockCientDemoApp</a> is included with the library. To run the demo,open the WallClockSync workspace (<em>WallClockSync.xcworkspace</em> file) in XCode. Choose the WallClockCientDemoApp target, build it and deploy the app on your iOS device.</p>

<p>On the server side, if you need an example implementation of a CSS-WC server. An example one is available in [<a href="https://github.com/bbc/pydvbcss">https://github.com/bbc/pydvbcss</a>]. In that repository, the <code>examples</code> folder has a server implementation: <code>WallClockServer.py</code></p>

<p>Run this WallClock Synchronisation server specifying a network interface address and a port number as illustrated below:</p>
<pre class="highlight plaintext"><code>$ python examples/WallClockServer.py 192.168.0.2 6677
</code></pre>
<a href='#licence' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='licence'>Licence</h2>

<p>The WallClockClient Framework is developed by BBC R&amp;D and distributed under Licensed under the Apache License, <a href="http://www.apache.org/licenses/LICENSE-2.0">Version 2.0</a>.</p>

<p>© Copyright 2016 BBC R&amp;D. All Rights Reserved</p>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; British Broadcasting Corporation, under <a class="link" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank" rel="external">Apache 2.0 open source licence</a></p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.2</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
